% use xelatex

% ======= Write out page numbers to aux file =======
\newwrite\pageNumbersFile
\immediate\openout\pageNumbersFile=\jobname.page-numbers.txt


% ======= Optional include files based on include dirs =======
% If directory Optional/NoImages is added to TEXINPUTS, this file defines
% the command \dontPrintImages
\InputIfFileExists{noimages.tex}{}{}


% ======= Include generated config =======
\input{config.tex}


% ======= Page size and margins =======
\documentclass[twoside]{book}

\providecommand{\bleedSize}{0.0in}
\providecommand{\innerBleedSize}{0.0in}
\providecommand{\gutterSize}{0.0in}

\usepackage[
  paperwidth=\dimexpr5.5in + \bleedSize + \innerBleedSize\relax,
  paperheight=\dimexpr8.25in + \bleedSize + \bleedSize\relax,
  inner=\dimexpr0.45in + \gutterSize + \innerBleedSize\relax,
  outer=\dimexpr0.45in + \bleedSize\relax,
  bottom=\dimexpr0.5in + \bleedSize\relax,
  top=0in, % total is 0.95 in for top
  headsep=0.5in,
  headheight=\dimexpr0.45in + \bleedSize\relax,
  includehead
]{geometry}

\setlength{\parindent}{0.2in}
\setlength{\parskip}{0pt}
\linespread{1.25}


% ======= Bookmarks =======
\usepackage[
  unicode,
  hidelinks,
  bookmarksopen,
  bookmarksnumbered
]{hyperref}


\newcommand{\addPdfBookmarkForChapter}[1]{
  \pdfbookmark[1]{#1}{chap:\theChapterNum}
}

\newcommand{\addPdfBookmarkForPart}[1]{
  \pdfbookmark[2]{#1}{part:\theChapterNum.\thePartNum}
}

% ======= Fonts =======
\usepackage[no-math]{fontspec}

\newfontfamily{\athiti}[Path = Fonts/Athiti/,
    Extension = .ttf,
    UprightFont = *-Regular,
    BoldFont = *-Bold,
    FontFace={el}{n}{*-ExtraLight},
    FontFace={l}{n}{*-Light},
    FontFace={md}{n}{*-Medium},
    FontFace={sb}{n}{*-SemiBold},
    FontFace={b}{n}{*-Bold},
]{Athiti}

\newfontfamily{\fakt}[Path = Fonts/Fakt/,
    Extension = .ttf,
    UprightFont = *-Regular,
]{Fakt-Soft}

\setmainfont [ Path = Fonts/AGaramondPro/,
    Extension = .ttf,
    UprightFont = *-Regular,
    ItalicFont = *-Italic,
    BoldFont = *-Bold,
    BoldItalicFont = *-BoldItalic,
    FontFace = {sb}{n}{*-Semibold},
    FontFace = {sb}{it}{*-SemiboldItalic},
    Scale=1.1,
    WordSpace=1.1,
    PunctuationSpace=0.0,
    LetterSpace = 0.0
]
{AGaramondPro}


% ======= Utilities =======
% \usepackage[english]{babel}
\usepackage{polyglossia}
\setdefaultlanguage{english}
\usepackage{microtype}
\usepackage{tikz}
\usepackage{soul}
\usepackage{xstring}

\newcommand{\textof}[2][sb]{{\fontseries{#1}\selectfont #2}}

\newcommand*\emptypage{\newpage\hbox{}\thispagestyle{empty}\newpage}
\newcommand*\newleftpage{\newpage\ifodd\value{realpage}\emptypage\fi}
\newcommand*\newrightpage{\newpage\ifodd\value{realpage}\else\emptypage\fi}

\newenvironment*{SpanEnv}
  { \providecommand{\SpanEnvClose}{} } % begin command
  { \SpanEnvClose } % end command

\newenvironment{realcenter}
 { \parskip=0pt\par\nopagebreak\centering }
 { \par\noindent\ignorespacesafterend }


% \ifEmptyElse{condition}{value if empty}{value if nonempty}
\newcommand{\ifEmptyElse}[3]{
  \def\tempparam{#1}\ifx\tempparam\empty #2 \else #3 \fi
}

\newcommand{\atTopOfPage}[1]{
  \begin{tikzpicture}[remember picture,overlay,every node/.style={inner sep=0,outer sep=0}]
    \node[anchor=north,yshift=0pt,xshift=0pt] at (current page.north) {%
      #1
    };
  \end{tikzpicture}%
}


% ======= Header =======
\usepackage{fancyhdr}
\setlength{\footskip}{5pt}

\fancyhf{} % clear all header fields
\fancyhead[LE,RO]{\athiti\fontsize{7}{1}\selectfont \textof[m]{\thepage}}
\fancyhead[CE]{\athiti\fontsize{7}{1}\selectfont \hspace{0.25in}{\fontseries{sb}\selectfont WORLDEND2}: \textof[m]{What Do You Do at the End of the World? Could We Meet Again Once More?,} \textof[el]{Vol.\volumeNumber}}
\renewcommand{\headrulewidth}{0pt}

\newcommand{\setChapterTitleInHeader}[2]{\fancyhead[CO]{\athiti\fontsize{7.5}{1}\selectfont \textof[sb]{\uppercase{#1}} \textof[m]{-{\lowercase{#2}}-}\hspace{0.25in}}}


% ======= Page Number =======
\pagenumbering{roman}

\usepackage{xassoccnt}

% We need this "realpage" counter so that newleftpage and newrightpage work as expected
\newcounter{realpage}
\DeclareAssociatedCounters{page}{realpage}
\AtBeginDocument{%
  \stepcounter{realpage}
}

% ======= Typography =======
\setlength{\lefthyphenmin}{2}
\setlength{\righthyphenmin}{3}
\setlength{\tolerance}{2000}
\setlength{\hbadness}{1000}
\setlength{\linepenalty}{10}
\setlength{\brokenpenalty}{100}
\setlength{\clubpenalty}{100}
\setlength{\widowpenalty}{100}
\setlength{\displaywidowpenalty}{100}
\setlength{\hyphenpenalty}{50}
\setlength{\exhyphenpenalty}{50}
\setlength{\spaceskip}{3.33333pt plus 1.66666pt minus 1.11111pt}
\setlength{\xspaceskip}{3.33333pt plus 1pt}
\setlength{\emergencystretch}{0.5em}
\raggedbottom


% ======= Splittable characters =======
\newcommand{\Ellipsis}{\ldots}
\newcommand{\EllipsisSplittable}{\Ellipsis \penalty50}


% ======= Content Commands =======
\newcommand{\icon}{
  % The icon takes up 3 lines
  % We use `realcenter` since `center` adds vertical space
  \begin{realcenter}
    \vphantom{1}

    \vphantom{2}\raisebox{-0.07in}[0em][0em]{\includegraphics[height=0.22in]{Images/ornament.png}}\vphantom{2}

    \vphantom{3}
  \end{realcenter}
}

\newcommand{\sectionTitleStyle}{\athiti\fontsize{11}{11}\fontseries{sb}\selectfont}

% These counted chapter numbers are mainly used for bookmarks 
\newcounter{ChapterNum}
\newcounter{PartNum}

% \beginChapter[part 1 name]{chapter title}{chapter subtitle}{image command}
\newcommand{\beginChapter}[4][\empty]{
  % Increment the chapter number and set the part number to 1
  \stepcounter{ChapterNum}
  \setcounter{PartNum}{1}

  % Insert the chapter image, setting the PDF bookmark for the chapter to the first page
  % of the image
  \insertDoubleImage[\atTopOfPage{\addPdfBookmarkForChapter{#2}}]{#4}

  \newrightpage
  \setChapterTitleInHeader{#2}{#3}
  \pagestyle{fancy}
  \thispagestyle{empty}

  %The blank space when starting a new chapter is 9 lines. The part title (if it exists) is around the middle, a bit below line 5
  \vphantom{1}\par\vphantom{2}\par\vphantom{3}\par\vphantom{4}\ifEmptyElse{#1}{}{\addPdfBookmarkForPart{#1}}\par
  \noindent\vphantom{5}\begin{picture}(0, 0)\put(0, -0.3\baselineskip){\sectionTitleStyle #1}\end{picture}\par
  \vphantom{6}\par\vphantom{7}\par\vphantom{8}\par\vphantom{9}
  \write\pageNumbersFile{ChapterPageNumber: \thepage}
}

\newcommand{\beginPart}[1]{
  \stepcounter{PartNum} % Increment the part number

  % The blank space when starting a new section is 3 lines. The section title is around the middle, a bit below line 2
  \vphantom{1}\addPdfBookmarkForPart{#1}

  \noindent\vphantom{2}\begin{picture}(0, 0)\put(0, -0.09\baselineskip){\sectionTitleStyle #1}\end{picture}
  
  \vphantom{3}
}

\newcommand{\insertPartText}[1]{\noindent\input{#1}}

\newcommand{\insertTableOfContents}[1]{
  \insertDoubleImage{#1}

  % The second page of the TOC is counted as "page 1"
  \setcounter{page}{1}\pagenumbering{arabic}
}


% ======= Image Commands =======

\newcommand{\tikzPicture}[3]{%
  \begin{tikzpicture}[remember picture,overlay,every node/.style={inner sep=0,outer sep=0}]
    \node[anchor=#1,yshift=0pt,xshift=0pt] at (current page.#1) {%
      \ifx\dontPrintImages\undefined
        \includegraphics[height=#2]{#3}%
      \else
        \phantom{\includegraphics[height=#2]{#3}}%
      \fi
    };
  \end{tikzpicture}%
}

\newcommand{\fullPageImage}[1]{%
  \tikzPicture{\ifodd\value{realpage}north east\else north west\fi}{\paperheight}{#1}
}

\newcommand{\insertSingleImage}[1]{
  \newpage\thispagestyle{empty}%
  \fullPageImage{#1}
}

% \insertDoubleImage[command between pages]{image filename}
\newcommand{\insertDoubleImage}[2][\empty]{
  \newleftpage\thispagestyle{empty}\fullPageImage{#2}
  {#1}
  \newrightpage\thispagestyle{empty}\fullPageImage{#2}
}


% ======= Credits page =======

% \creditsPage{backgroundImage}{copyrightYear}{formattedIsbn}{versionTag}
\newcommand{\creditsPage}[4]{
  \newleftpage\thispagestyle{empty}

  \begingroup

  \newgeometry{
    inner=\dimexpr0.45in + \gutterSize + \innerBleedSize\relax,
    outer=\dimexpr0.28in + \bleedSize\relax,
    bottom=\dimexpr0.45in + \bleedSize\relax,
    top=\dimexpr0.45in + \bleedSize\relax
  }

  \fullPageImage{#1}

  \setlength{\parindent}{0pt}
  \setlength{\parskip}{0.85em}
  \linespread{5.5}
  \spaceskip=2.45pt

  \fakt\fontsize{6.25}{0.15em}\selectfont
  \raggedright

  {
    \setlength{\parskip}{0.5em}\athiti\fontsize{11}{1}\selectfont
    {\fontseries{b}\selectfont WORLDEND2:} {\fontseries{md}\selectfont WHAT DO YOU DO AT THE END OF THE WORLD?

    COULD WE MEET AGAIN ONCE MORE?}
  }

  {\fontsize{7}{1}\addfontfeature{LetterSpace=5}\spaceskip=4pt\selectfont AKIRA KARENO}

  Translation by the Orlandri Translation Company \\
  Cover art by ue

  This book is a work of fiction. Names, characters, places, and incidents are the product of the author’s imagination or are used fictitiously. Any resemblance to actual events, locales, or persons, living or dead, is coincidental.

  SHUMATSU NANI SHITEMASUKA? MO ICHIDO DAKE AEMASUKA? Vol.~\volumeNumber \\
  ©#2 Akira Kareno, ue \\
  First published in Japan in #2 by KADOKAWA CORPORATION, Tokyo. \\
  ISBN: #3 (original)

  English translation by the Orlandri Translation Company.\\
  https://orlandritl.wordpress.com

  This print edition is edited and produced by the WorldEnd Formatting Project. \\
  Visit us at https://worldend.github.io

  Release: #4 \\
  The source code for this release can be found at https://github.com/WorldEnd/worldend-formatting

  This is a free, unofficial translation made entirely by dedicated WorldEnd fans. Please support this series by purchasing official merchandise, including the official translation if one is ever released.

  \restoregeometry

  \endgroup
}

% ======= Document =======

\begin{document}

\input{content.tex}

\end{document}
